# Formatted with Black
# https://black.now.sh/?version=stable&state=_Td6WFoAAATm1rRGAgAhARYAAAB0L-Wj4DNiDm9dAD2IimZxl1N_Wk6rkmrIVYGF2f6jjaZ38Qw5Sa1-cFtDHwlTZRfJYYk61vi1w6kBDUj-SgU4hp8J9Xc49E4Jkolu5Gn2tBCA1VpePUjd2py3tgSdFpmuRjoMMZozya7BAT5X6_UJ__zruP8gmCI7_j-uNTbQDyrAHGIBumc2fbpsC6WAxnVrJsGsKbQy8LnyUOvZrVb67syL-tSmjTLEiaCobw9AG54F_FUEiaxykYOk9nYIUnJ_a9n3EDUfXCR7Pk5lM72Xz8VyFZ2rjI2spWcFlmtZ6yLbCI2VnQYh9HovF4yBZuGGkCW8xblh6Ry4I5Vqh9rl8n8xdGFud73gFz_EehWqo7RP1VnmNQoi2FtP7Q8mV5SzCLJRKr5vOFyq3ysw9ADSVbMIFfWvXMrHnPDaNl10weMZWlbatEbY0qnkVM3iuBmxVYGlFv5moA32rFfmJLYPFnjTmyy6RYrB6N6ERE5itb9V4_cKQ5qTR-RRX1ACA1LQv-lWbf7M0np06NJzsvvYd-6-svsyITp7rCmDYoWIDF94CBLhxwpqHq5SlsdnrhyDXFM2eNeRV4QP_YISNNitO3oReqYUo0dE8byaH8e7DTjGFUaaK6eMgw-WMEA9kRmxkKH_OxtEb1W4888snG04MvHSCm9KS7V10mlI7wIquqWsAsfgGm1HVVgINyrqQ-GLvC2hfSt_FwD-ET0Y2gm2f6519Zzl60yi3RfXj5U0XNmIdxQqVqvitffHr8rHH7V7ZY6G08VN2Y3w4NYILYrC89x182JCbPD68B88PTLrLeXZ20VGJDcvFkNfkufZ6_6UAJ9PBQLi0YeX0Z0Y1zUKNc-KC7bz88L58196kJycOJp9eidTEVKl0PUW7GPWXUXobzEdQkpkBY4GFLlsyx246m5nTdEawGAPnxul5iSUpM5rHMqyTgz1ZbktKbsvr0yCRBC7iiH0KaOJesrJozo8M1PLCg8N73P24z2ZwCpaYsfj2pcT3tKE1z4O0avk04DbMdR8BIFp-5kq-twcAWV9XivZd1RRSrHekJR1B8dGmgquBcTXPONOgbAbqgcGEJqWxcgmVJPsEx3qh239DGaes-VDCCD1w2a9Xskl1qji8ISHLtTHVWbZ2zjYTAAFYS3GNu-r84jWqpn3urT8S3HDICsSp255am7vNL5WK6KLLmkIysq3hm7esgwO3CeszVuX5PsGamx5Rd0NC13IIuYWprC-Bvjc8atpDybf6gCAW8ep_4W1EjsbfIVFEGAz3_j3hd1EsUtNjyUeII-OjKd3mAt_2A6d1_KQnq9ZoGLiP8wV9enXvUauu4EVYAgHFpe8AW9Yjruiy8MEjXMleILQHiD9p7Gh9Yo90DeYMZ9QlePyfzmjAf7-p45-fxG9cpujGrbGXC42nMG3CK8ChFE_qi7okAtQlG8b870UfiJpRTSkR6e5QwHgLiJkOdMrN82OR-QMDqdTfNf9zyK7iRfE30IqlP_xK-LhVGAvAe6QHXPd1T1kfeOTz7DduVkHvT01V-IVlydJZIM-2RRNX168cMS4x2fDJJPqntmvykR2YUQiDnqHf5wu_b1Tc6Fl2xE_Yy_Varh-P3uYRF6uOxYAydW59-AHWqHO5CyjB34IMKQaV2m70hV4Ap88RInXFnL9qf5vm8DlMRjbEJYegsM2aNgdBUXd53mI7RA0E9nl42q1eUjwVoYZczj5R0gwoCpye9SYTpbNFsBfDTiNqjYJhO1HHskvkJI8NpAWoDmzk-hclZtSLi_itJWU2CdSiws-fZN3IVToIEuce3k6n1pYtkxxeIbhivfKxL2YRiqINXP7By2vhyvnYPGLtSpVd3SEYE1sUnwkX4RMtxBN_1CDdhVhmwt_EdxrR4KCLNzZ1jArQsBa63djYlwk8EXhkLPDwoBqKGiG5saskMPhNHu849otxS3Jak1EXkE2o170zJ68ThweoKABFtNun19sFniSn4mXUWX0KlXPLpJtVY9ku_4e40hHwXuF4RBApYxFHQYRqvZN3pO2l52Xm9rJq2KKw7hsjp_PbIle5_RTwqVqWDCLEF8LCo3b5FDVD9qZ7EiyN7dqU59x2nB2c36VtT1GS4dTkUXomHNoY8zGW_8NzEXbOOgzq4XHlbnv29mElhqETxRe3WPUGmpH8JlWrPdsgfpolU2U78PnVFOLXX6ic_tviWLE0TJ0nqGRXhyqwAu4yFlBsrdnN2tHkaOxauVZAsDgbewxPevp5_utmzzAuL-ZeC88kbRfEeMqEe-bZ48hcpdJEu7kDv4KYA2wXel-cZtXrkSIp3TuAzXmc2no93Lhyp6SaBMN7bV_XLttOT9omuNaALvsfGhuNVbgbiROeIPUSdh5F6VvuR3U-jD8zyIBVeM7iSlmoGcHMwYXsJ7HCwp-oGuqmQ0b4OSHbU8n9qwg3vnclS_lFQ3mr9XpI1S-XsxdZCQ0OQfpkcF6qA4U-93NBAKFXGl_vw42d9z7HSsw_Yuh3uBa19eolKfMu0iDVJTND0DnN5q64vzNQBm0bAzxTOBTzBRIZNu41fbcbd6NzwkY_Pqk5F2gl8YtMbEArqyqWUAB5FxlvmE3D4WeEwVLv47fa-CIzhtQ0fYm8aUmlfFtpilKybn77kOKTcg_8sLacrkVkhJRidFkOzDULyv4yhfiE3Y7wW4CumcEdV4DRrJ_mJVCl3igI_Plz4TgmZDPrNr-bBUgX57foT4tgjvYQRs1KQj83TF8yVE18ZrvM8uymAT-oEbdHilJT2xROkhOGrZon8J7bXZmjjz7URdU4KEpYdM54OBbB54ZmZS7KvVqLXXt9o5QgMRVdoPs3Jx_0jpkMUnjKTavQ0VhcbBmW9Thht703ALJ5ujtNmTw7otmqpxxUUy8YR1tOlR_1VPVfozsEpONpGTWWxTtV2VajDnLsqa2C9fjY8-pFQtFMyvaDYJD6KDEhiIRsPIoCVj5rIUf_AwOS7ZC03A_WImawiTvUIMFq9lpYAowCBj6zENLf4-1Jq1IR9S0_27YsZPkiNMiGe8DuEyrTQozwe1iXmYlT9UekkbRfFqNmsOc2xp2m1FiLVSSn7pR-I9B0Y7oR1kGj8zk__C-_1Qu67njAajgzStv-sXcUoDm2X9jG7a46Frl4kLE02wlb5ubF-wAjVBMyCErkDhbfOCquNTu1vlVyWIN_vq_SiRS6QZ1ru_SzDYKSZBE0ZhHABh_6isF3jTpRmJBEIIoeSzLN-eIjxKQmjuEHtM9nL0PY_EpLk4kiP-gumVzVaozmbLf3ioUDfs4ZPU40pL0K8TosEV9V7b--js2qAYi8h6uKbt-sSv_eDxeSl9wkgUEfA3OIe--s7fg1uGDZQPEXLi3zntX64_WSI71YOxsrGY7kDNBGxabnhBom_R5oWOUenOYGZoxOtoDIA5D3sZlqzIF3Hs82mU7dKpXF0objEYHMPSpjtTsy1lup1YdqnQw5CzGUFSrfWagtl6wNcXvVG6cq-SYtH3Lza5yTkMQJLVJE-w42QW8gj8G5EZwCxsL2KelGoMaDA2muF7jJTQ_e0dyy7plax_ycNBVz93zzqJK1mxWJEdceUGixi2j_9lB9bYSESvoXWvC40g5mN2wNTkkoFc-kDVg-GMjcrD2fZD1IlDW-6_Pp_d16I4isvtxCNT6QAMc6xB0pqBDCL3lw2-JMglGxqGqeb1Bs7UD0fp1RYYXJWX7cYyNnHdBt8IMrhQIZKcbFDo6z4fwcV5jmvxBuK7pVHccydwN2saEyAZUj8hwfDywRbhUu80qNXO9R-FEJZ7A-ZgUQXZhEpvzzphse10CoxBtDUyQZfA33-qOpXpdKof-2ru4zIHcmmBDXrY3ldMMVbQMq2z2xAdUnY6OaxmUXqE6wHXCjtFMiFuTGHcUy3HZmwncc4VH8jutGsSRYZRhg4uFzV9n4PefDa5SPiVMmr2Lt9GekAmqJbCymvHyGCGSPZB_rM-KYPlrccgMmOuT3KzUgmmV60Oi89v--xXeU8XlX2BHCPR58hK47rrVo_rmObs9aY1g3Hd_6jeOSJPecw-QWov1zp899Qz_r2rI1Fzqqv5pFuLulaTViXNRvf55K-ptBqi3uWneXO53ofxN5jGg5uPW479FN7PPJh3JbwOO-_jTr70OJ2omaAZXwmDWgpdyg482LfraViF07mcIuqZk7vxB6iB-oKBpXtL3jM5W9nzWmSUnvrECdf4Nk5g62wMBvawllVwZfnvSlc6x_xWwSgPkXUzk3GX_jXsYwOn1ip3BGHHjjrBM5QaKkClPam3nUIirsXEqv34SJmRNt3jPOsWXxo7wP0nTJanJcEFU4pUpUtOH5QG9uH9QzESJjoEviYa-_4Dgb7dVLrQpfBnD7Y0KBwf_1j4n7-8WBHhpe_dI1WlFtpwJLKCwh696nGKgoSvBDIVp8PbCKH6zXrQUbYFuv9s35Wh5D57TX99IMrBPto_UiLfB9VFnCWaLR-VihJ_9mYs9AT0tHttD1VNOCPtcV8DN6x2iB6eWdBxXCqQLd57U-ldiTftNFs2ymwyQajaTaE6QbpQsoFXGkS7EG--GgQKhoT57WQ2gRvrp6Iao4XJcDPrD5LePdv1EVGROWTsLjs3UEcaEwa_KXbT3W6i2xuSbcPXMw1djPgYiM1yJOSYckcMvl_xTzqYXsRlKAFHIXUUkGkm8tUeY1BRJaOGIjLTol8iINZhuF-qvA_u8wGEl2SXSXrjn3zStC9jfK46e1u_91gwYwfuF0xNZBOOQ-3ArPFuw8qOVNE7wd9bpBXKRLB84kM7Ba_qdh8C7XWBa_AxU8qFm6sKwZn5_tRcxERfH76eMi1wOsQSAQsVY6QO8g2jiF7FSGvVxscFsvh118Ctc6wAFUrSqZPm-ZLEPiCc_bdTVs1sDg99Dsl8QDTZu6KQvHLdKcKHUy-vxAADy7UUhebDspAABix3jZgAAsTrCp7HEZ_sCAAAAAARZWg==

from lxml import etree, html
from lxml.html.clean import clean_html
import pandas as pd
from datetime import date, datetime
import requests
import re
import os
import shutil
from ASECORP_BBDD import tagea_BBDD_ASECORP, devuelve_patrones


# # # Recoge resumen diario del BOE de hoy
#
today = date.today()
#
# # dd/mm/YYYY
hoy = today.strftime("%Y%m%d")
print("Fecha de Hoy =", today.strftime("%d/%m/%Y"))
#
# # dd
# d = today.strftime("%d")
# print("dia =", d)
#
# # mm
# m = today.strftime("%m")
# print("mes =", m)
#
# # YYYY
# Y = today.strftime("%Y")
# print("año =", Y)
#
# print(today.strftime("%d/%m/%Y"))

## Crea función que convierte lista a string en todas las columnas de tabla_analisis
## para evitar en presentación final los caracteres [' '] propios de las listas
def list2Str(lst):
    if type(lst) is list:  # apply conversion to list columns
        return ", ".join(lst)
    else:
        return lst


def save_html(html, path):
    with open(path, "wb") as f:
        f.write(html)


# Define expresiones REGEX para búsqueda de leyes, decretos, etc. referenciadas anteriormente
# pattern = ['Ley [0-9]+\/[0-9]+','Ley Orgánica [0-9]+\/[0-9]+','Decreto [0-9]+\/[0-9]+','Real Decreto [0-9]+\/[0-9]+','Real Decreto Legislativo [0-9]+\/[0-9]+','Real Decreto-ley [0-9]+\/[0-9]+','Orden [A-Z]+\/[0-9]+\/[0-9]+','Orden Circular [0-9]+\/[0-9]+','Reglamento \(UE\) [0-9]+\/[0-9]+', 'Reglamento de Ejeución \(UE\) [0-9]+\/[0-9]+' ,'Sentencia de [0-9]+ de [a-z]+ de [0-9]+','Sentencia [0-9]+\/[0-9]+','Orden de [0-9]+ de [a-z]+ de [0-9]+', 'Resolución de [0-9]+ de [a-z]+ de [0-9]+','Resolución [a-z]+\/[0-9]+\/[0-9]+', 'Nota de Servicio [0-9]+\/[0-9]+', 'Acuerdo multilateral M\-[0-9]+', 'Acuerdo Multilateral RID [0-9]+\/[0-9]+', 'Circular [0-9]+\/[0-9]+', 'Decisión \(UE\) [0-9]+\/[0-9]+', 'Decisión de Ejecución \(UE\) [0-9]+\/[0-9]+', 'Instrucción IS\-[0-9]+']
pattern = devuelve_patrones()

# --------------------------------------------------------------------------------------
# DOUE
# --------------------------------------------------------------------------------------

URL_HTML_resumen = "https://eur-lex.europa.eu/oj/direct-access.html?locale=es"

## carga página HTML y genera árbol

print("Accediendo a página del boletín")

headers = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"
}
response = requests.get(URL_HTML_resumen, headers=headers)
tree = html.fromstring(response.text)

## Recoge Nombre Secciones Sumario

secciones = tree.xpath(
    '//*[@class="table table-striped table-hover table-condensed OJTable AllBordersTable"]'
)
# print(secciones)

print("Accediendo a página resumen de disposiciones")

source_dir = "./DOUEs"
target_dir = "./DOUEs_Anteriores"

file_names = os.listdir(source_dir)

for file_name in file_names:
    # Evita que de error si el fichero que se mueve ya existe en dir destino
    try:
        os.remove(os.path.join(target_dir, file_name))
        shutil.move(os.path.join(source_dir, file_name), target_dir)
    except OSError:
        shutil.move(os.path.join(source_dir, file_name), target_dir)


## Recoge Valores para formar URLs Secciones Sumario

df_secciones_sumarios = pd.DataFrame()
for seccion in secciones:
    seccion_name = seccion.xpath("./tbody/tr[1]/td[2]/a/text()")
    seccion_URL = seccion.xpath("./tbody/tr[1]/td[2]/a/@href")
    # seccion = re.sub('(\\r|\\n|\\t)+', '', seccion)
    # print(seccion_name)
    # print(seccion_URL)


### Si no hay disposiciones hay que gestionar el error y salir del script
# if len(seccion_name) == 0:
#    print('No hay disposiciones')
#    # exit()

for row in range(len(seccion_name)):
    df_secciones_sumarios = df_secciones_sumarios.append(
        {
            "Seccion": seccion_name[row],
            "Seccion_link": "https://eur-lex.europa.eu" + seccion_URL[row][4:],
        },
        ignore_index=True,
    )


# if len(df_secciones_sumarios['Seccion'][0]) == 0:
#    print('No hay disposiciones')


DOUE_sumarios = pd.DataFrame()

print("Accediendo a página detalle de disposiciones")

for URL in df_secciones_sumarios["Seccion_link"]:

    ### Recoge Items en Seccion Legislación

    # print(URL)
    response = requests.get(URL)
    sumario_HTML = html.fromstring(response.text)

    documentos_Name = sumario_HTML.xpath('//*[@class="oj-ti-doc-dur"]/a[1]/text()[1]')
    documentos_URL = sumario_HTML.xpath('//*[@class="oj-ti-doc-dur"]/a[1]/@href')

    for row in range(len(documentos_Name)):
        DOUE_sumarios = DOUE_sumarios.append(
            {
                "Seccion": "L" + documentos_URL[row][-7:-4],
                "Item_Title": documentos_Name[row],
                "Item_Link": "https://eur-lex.europa.eu" + documentos_URL[row][10:],
                #'Item_Tag': documentos_URL[row][-45:-29],
                "Item_Doc_Name": "",
                "Fecha_publicacion": "",
                "PDF_Link": "",
                "Tags": "",
                "Match_ASECORP_BBDD": [],
            },
            ignore_index=True,
        )


def save_txt(txt, path):
    with open(path, "w") as f:
        f.write(txt)


documentos_FileName = sumario_HTML.xpath('//*[@class="DocumentTitle pull-left"]/text()')

print("Generando Tags de patrones encontrados en disposiciones")

row = 0
for link in DOUE_sumarios["Item_Link"]:
    sumario_Text = []
    ### Recoge PDF link en Items Legislación

    response = requests.get(link)
    sumario_HTML = html.fromstring(response.text)

    PDF_Link = sumario_HTML.xpath('//*[@id="format_language_table_PDF_ES"]/@href')
    DOUE_sumarios["PDF_Link"][row] = "https://eur-lex.europa.eu" + PDF_Link[0][10:]

    Item_Doc_Name = sumario_HTML.xpath('//*[@class="DocumentTitle pull-left"]/text()')[
        0
    ][9:]
    DOUE_sumarios["Item_Doc_Name"][row] = Item_Doc_Name

    # Item_Fecha = str(sumario_HTML.xpath('//*[@class="oj-hd-date"]/text()'))
    # Item_Fecha = datetime.strptime(str(raiz.xpath('//*[@class="oj-hd-date"]/text()'))[0:-2],"%d.%m.%Y")
    Item_Fecha = re.findall(
        "[0-9]+\.[0-9]+\.[0-9]+",
        str(sumario_HTML.xpath('//*[@class="oj-hd-date"]/text()')),
    )
    DOUE_sumarios["Fecha_publicacion"][row] = datetime.strptime(
        str(Item_Fecha)[2:-2], "%d.%m.%Y"
    ).date()

    ### Recoge Texto de Items

    Item_Text = sumario_HTML.xpath('//*[@class="oj-normal"]/text()')

    # [ sumario_Text.append(re.sub('(\\r||\\n\\t|\\xa0)+', '', item)) for item in Item_Text ]
    [sumario_Text.append(item) for item in Item_Text]

    ### Sustituye caracteres 'n.' por 'n.º' ya que al importar de HTML se pierde el caracter º

    sumario = "".join(sumario_Text).replace(" n.", " n.º")
    # print(sumario)
    ### Busca tags en texto

    DOUE_sumarios["Tags"][row] = list(
        set(re.findall("|".join(pattern), sumario, flags=re.IGNORECASE))
    )

    ### Salva texto de Items en formato TXT

    save_txt(sumario, "./DOUEs/Resumen-DOUE-" + Item_Doc_Name + ".txt")
    # print(sumario)
    # print('./DOUEs/Resumen-DOUE-' + Item_Doc_Name + '.txt')
    # print(Item_Doc_Name)

    # print(list(set(re.findall('|'.join(pattern), sumario, flags=re.IGNORECASE))))

    row += 1


# Elimina Tags duplicados
for i, row in DOUE_sumarios.iterrows():
    DOUE_sumarios["Tags"][i] = list(set(DOUE_sumarios["Tags"][i]))
    # print(DOUE_sumarios['Tags'][i])


### Ordena Columnas
DOUE_sumarios = DOUE_sumarios[
    [
        "Seccion",
        "Item_Doc_Name",
        "Fecha_publicacion",
        "PDF_Link",
        "Item_Title",
        "Item_Link",
        "Tags",
        "Match_ASECORP_BBDD",
    ]
]
DOUE_sumarios


### Crea lista plana de Tags sin duplicados
DOUE_flat_list = list(set([item for row in DOUE_sumarios["Tags"] for item in row]))

print("Generando Tags de patrones encontrados en BBDD ASECORP")

# Inicializa datos de BBDD_ASECORP
boletin_ASECORP_flat_list = []
ASECORP_BBDD = pd.DataFrame()
ambitos = []

# Incluir en llamada a función el ambito territorial como lista
# si no se especifica ámbito los incluye todos
boletin_ASECORP_flat_list, ASECORP_BBDD, ambitos = tagea_BBDD_ASECORP(
    ["España", "Europa"]
)

## Busca coincidencias entre lista boletines BOEs explorados y lista boletines de BBDD ASECORP
list(set(DOUE_flat_list) & set(boletin_ASECORP_flat_list))

print("Realizando Matching entre Tags encontrados en disposiciones y en BBDD ASECORP")

for i, row_to_compare in DOUE_sumarios.iterrows():
    for j, row_comparing in ASECORP_BBDD.iterrows():
        if set(row_to_compare["Tags"]) & set(row_comparing["Tags"]):
            DOUE_sumarios["Match_ASECORP_BBDD"][i].append(ASECORP_BBDD["Codigo"][j])
            # print(str(set(row_to_compare['Tags']) & set(row_comparing['Tags'])) + ' ' + str(row_comparing['Codigo']))


## Aplica función de conversión de listas a strings
DOUE_sumarios = DOUE_sumarios.apply(lambda x: [list2Str(i) for i in x])


DOUE_sumarios_CSV = pd.DataFrame()
DOUE_sumarios_CSV = DOUE_sumarios

# Compone y genera enlace a PDF del DOUE correspondiente
DOUE_sumarios_CSV["PDF_Link"] = (
    "=HIPERVINCULO("
    + '"'
    + DOUE_sumarios["PDF_Link"]
    + '";'
    + '"'
    + "Doc: "
    + DOUE_sumarios["Item_Doc_Name"]
    + '")'
)

print("Guardando resultados en fichero")

### Genera fichero CSV

DOUE_sumarios_CSV.to_csv(
    "./ASECORP/Resultados_Matching_DOUE_" + today.strftime("%Y%m%d") + ".csv",
    index=False,
)
